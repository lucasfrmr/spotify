doctype html
html(lang='en')
  head
    meta(charset='UTF-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    title Spotify Search
    // Include Bootstrap CSS
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css", rel="stylesheet", integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC", crossorigin="anonymous")
    script(src='https://code.jquery.com/jquery-3.6.0.min.js')
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js", integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM", crossorigin="anonymous")
  body
    .container.mt-5
      .row.justify-content-center
        .col-md-6
          .input-group.mb-3
            input#searchInput.form-control(type='text', placeholder='Search for a song', aria-label='Search for a song')
            button.btn.btn-outline-secondary(type='button') Search

      .row.justify-content-center
        .col-md-8
          table#resultsTable.table.table-responsive.mt-4
            thead
              tr
                th Song
                th Artist
            tbody

    script.
      $(document).ready(function() {
        let offset = 0;

        async function searchSpotify(query) {
          const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&offset=${offset}`, {
            headers: {
              'Authorization': 'Bearer !{globalAccessToken}',
            },
          });

          const data = await response.json();
          const resultsTable = $('#resultsTable tbody');
          resultsTable.empty(); // Clear previous results

          data.tracks.items.forEach(item => {
            const tr = $('<tr>');
            const songLink = $('<a>').attr('href', item.external_urls.spotify).text(item.name);
            const songName = $('<td>').append(songLink);
            const artistName = $('<td>').text(item.artists[0].name);
            tr.append(songName, artistName);
            resultsTable.append(tr);
          });

          offset += data.tracks.items.length;
        }

        // Trigger search on input change
        $('#searchInput').on('input', function() {
          const searchQuery = $(this).val().trim();
          offset = 0; // Reset offset when the user starts a new search
          if (searchQuery.length > 0) {
            searchSpotify(searchQuery);
          }
        });
      });
